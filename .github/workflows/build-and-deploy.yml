# =================================================================
# == Nameless Mall Frontend CI/CD (v2.1 Integrated)
# == å‰ç«¯å°ˆæ¡ˆç¨ç«‹æ§‹å»ºï¼Œä¸¦è§¸ç™¼å¾Œç«¯ Monorepo éƒ¨ç½²
# =================================================================

name: Frontend Build and Deploy

on:
  push:
    branches: [ "main", "master" ]
    # å®Œæ•´ç›£è½å‰ç«¯é—œéµè·¯å¾‘
    paths:
      - 'app/**'
      - 'features/**'
      - 'components/**' # æ–°å¢ž: UI çµ„ä»¶
      - 'lib/**'        # æ–°å¢ž: å·¥å…·å‡½å¼
      - 'hooks/**'      # æ–°å¢ž: React Hooks
      - 'shared/**'
      - 'public/**'
      - 'package.json'
      - 'next.config.mjs'
      - 'tailwind.config.ts'
      - 'Dockerfile'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  REGISTRY: asd902648
  IMAGE_NAME: frontend-app
  # å®šç¾©éƒ¨ç½²å€‰åº« (å¾Œç«¯/Infra å€‰åº«)
  DEPLOY_REPO: IsAliveQwQ/nameless-mall

jobs:
  # =================================================================
  # éšŽæ®µé›¶ï¼šç’°å¢ƒæ¸…ç† (ç¢ºä¿ä¹‹å‰çš„ç†±ä¿®å¾©ä¸è¢«èˆŠå¿«å–å¹²æ“¾)
  # =================================================================
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Force Purge Artifacts and Runs
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ§¹ Step 1: Deleting all individual artifacts..."
          gh api repos/${{ github.repository }}/actions/artifacts --paginate --jq '.artifacts[].id' > art_ids.txt || echo ""
          
          if [ -s art_ids.txt ]; then
            echo "Found $(wc -l < art_ids.txt) artifacts. Deleting..."
            while read -r id; do
              gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/$id || true
            done < art_ids.txt
          fi

          echo "ðŸ—‘ï¸ Step 2: Deleting all old runs (Bulk purge)..."
          gh run list --repo ${{ github.repository }} --limit 100 --json databaseId -q '.[].databaseId' > run_ids.txt
          while read -r id; do
            if [ "$id" != "${{ github.run_id }}" ]; then
              gh run delete $id --repo ${{ github.repository }} || true
            fi
          done < run_ids.txt
          
          echo "âœ… Quota recovery finished."

  # =================================================================
  # éšŽæ®µä¸€ï¼šä»£ç¢¼å“è³ªæª¢æŸ¥
  # =================================================================
  lint:
    needs: cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # æš«æ™‚å…è¨±é€™äº›æ­¥é©Ÿå¤±æ•— (|| true)ï¼Œä»¥å…é˜»æ“‹ CI
      - name: TypeScript Check
        run: npm run type-check || true

      - name: ESLint Check
        run: npm run lint || true

  # =================================================================
  # éšŽæ®µäºŒï¼šæ§‹å»º & æŽ¨é€ Docker Image
  # =================================================================
  build:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=https://isaliveqwq.me/api
          cache-from: type=gha
          cache-to: type=gha,mode=max
  
  # =================================================================
  # éšŽæ®µä¸‰ï¼šç¨ç«‹éƒ¨ç½² (Direct SSH)
  # ç›´æŽ¥é€£ç·šä¼ºæœå™¨æ›´æ–°å‰ç«¯å®¹å™¨ï¼Œå®Œå…¨ä¸ä¾è³´å¾Œç«¯å€‰åº«
  # =================================================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Deploy Frontend Container
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            echo "ðŸš€ Starting Frontend Deployment..."
            cd ~/mall-deployment
            
            # 1. æ‹‰å–æœ€æ–°å‰ç«¯é¡åƒ
            echo "â¬‡ï¸ Pulling latest image..."
            docker compose pull frontend-app
            
            # 2. é‡å•Ÿå‰ç«¯å®¹å™¨ (Zero Downtime if scaled, but here likely brief interruption)
            echo "ðŸ”„ Restarting container..."
            docker compose up -d frontend-app
            
            # 3. æ¸…ç†èˆŠé¡åƒ
            docker image prune -f
            
            echo "âœ… Frontend deployed successfully!"

